<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>রক্তদাতার তালিকা - রিয়েল টাইম</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --khoiri: #800000; --bg-gray: #E5E1E1; }
        body { background-color: var(--bg-gray); font-family: 'SolaimanLipi', sans-serif; margin: 0; padding-bottom: 40px; }
        
        .header-main {
            background: linear-gradient(135deg, var(--khoiri) 0%, #b30000 100%);
            border-radius: 0 0 35px 35px;
            padding: 45px 20px 65px;
            color: white; text-align: center; position: relative;
        }

        .donor-card {
            background: white; border-radius: 30px; padding: 22px;
            margin: 25px 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.06);
            position: relative; border: 1px solid #f0f0f0;
        }

        .image-container { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .donor-image { width: 75px; height: 75px; border-radius: 22px; object-fit: cover; border: 3px solid #f9f9f9; background: #eee; }
        .blood-group-label { background: var(--khoiri); color: white; font-size: 14px; font-weight: 900; padding: 2px 14px; border-radius: 10px; }

        .status-badge { font-size: 11px; font-weight: bold; padding: 6px 14px; border-radius: 50px; display: inline-flex; align-items: center; gap: 6px; margin-top: 10px; }
        .available { background: #DCFCE7; color: #166534; }
        .unavailable { background: #FFE4E6; color: #E11D48; }

        .action-area { display: flex; gap: 12px; margin-top: 20px; padding-top: 18px; border-top: 1px dashed #eee; }
        .btn-call { flex: 1; background: var(--khoiri); color: white; padding: 14px; border-radius: 18px; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; }
        
        .btn-check { width: 55px; height: 54px; background: white; color: #10B981; border: 2px solid #10B981; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 22px; transition: 0.3s; }
        .btn-check.disabled { border-color: #D1D5DB; color: #9CA3AF; cursor: not-allowed; }

        /* Loader */
        #loader { text-align: center; padding: 50px; display: block; }
    </style>
</head>
<body>

    <div class="header-main">
        <button onclick="window.location.href='index.html'" class="absolute left-6 top-8 text-white text-xl"><i class="fas fa-arrow-left"></i></button>
        <h2 class="text-2xl font-black italic">BLOOD DONORS</h2>
        <p class="text-xs opacity-80 mt-1">সরাসরি ডেটাবেজ থেকে আপডেট করা হচ্ছে</p>
    </div>

    <div id="loader">
        <i class="fas fa-spinner fa-spin text-3xl text-[#800000]"></i>
        <p class="mt-2 text-gray-500">ডোনার লিস্ট লোড হচ্ছে...</p>
    </div>

    <div id="donorContainer" class="mt-6"></div>

    <script>
        // আপনার Web App URL এখানে বসান
        const scriptURL = "https://script.google.com/macros/s/AKfycbyrLKtlPIYoa-Qwn1oc8TZ1pNULQeRJpK1r9ac6bJeLWpuRKAlu5_JVqaFUr47TSZ7XyA/exec";

        async function fetchDonors() {
            try {
                const response = await fetch(scriptURL);
                const data = await response.json();
                renderDonors(data.donors);
                document.getElementById('loader').style.display = 'none';
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('loader').innerHTML = "ডেটা লোড করতে সমস্যা হয়েছে।";
            }
        }

        function checkAvailability(lastDate) {
            if (!lastDate || lastDate === "") return { canDonate: true, daysLeft: 0 };
            const last = new Date(lastDate);
            const today = new Date();
            const diffDays = Math.ceil((today - last) / (1000 * 60 * 60 * 24));
            return { canDonate: diffDays >= 90, daysLeft: 90 - diffDays };
        }

        function renderDonors(donors) {
            const container = document.getElementById('donorContainer');
            container.innerHTML = "";

            donors.forEach((donor) => {
                if(donor.status !== "Active") return;

                const info = checkAvailability(donor.lastDonate);
                const donorImg = donor.image || 'https://via.placeholder.com/150';

                const card = `
                <div class="donor-card">
                    <div class="flex gap-5 items-start">
                        <div class="image-container">
                            <img src="${donorImg}" class="donor-image">
                            <span class="blood-group-label">${donor.bloodGroup}</span>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800 text-lg">${donor.name}</h3>
                            <p class="text-xs text-gray-500 mt-2"><i class="fas fa-map-marker-alt text-red-600 mr-2"></i> ${donor.district}, ${donor.upazila}</p>
                            ${info.canDonate 
                                ? `<span class="status-badge available"><i class="fas fa-check-circle"></i> বর্তমানে এভেলেবল</span>`
                                : `<span class="status-badge unavailable"><i class="fas fa-clock"></i> ${info.daysLeft} দিন পর এভেলেবল</span>`
                            }
                        </div>
                    </div>
                    <div class="action-area">
                        <a href="tel:${donor.phone}" class="btn-call"><i class="fas fa-phone-alt"></i> কল দিন</a>
                        <button onclick="updateDonationStatus('${donor.phone}', ${info.canDonate})" class="btn-check ${!info.canDonate ? 'disabled' : ''}">
                            <i class="fas ${info.canDonate ? 'fa-check' : 'fa-ban'}"></i>
                        </button>
                    </div>
                </div>`;
                container.innerHTML += card;
            });
        }

        async function updateDonationStatus(phone, canDonate) {
            if (!canDonate) return;
            if (confirm("আপনি কি নিশ্চিত যে এই ডোনার আজ রক্ত দিয়েছেন?")) {
                const formData = new FormData();
                formData.append('action', 'updateTick');
                formData.append('Phone', phone);

                alert("আপডেট হচ্ছে... অনুগ্রহ করে অপেক্ষা করুন।");
                await fetch(scriptURL, { method: 'POST', body: formData });
                location.reload(); 
            }
        }

        window.onload = fetchDonors;
    </script>
</body>
</html>
